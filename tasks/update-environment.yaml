# Update a single environment
# Called with 'env' variable containing environment config
---
- name: "Set environment-specific variables for {{ env.name }}"
  ansible.builtin.set_fact:
    env_deploy_dir: "/opt/brc-analytics-{{ env.name }}"
    env_backend_dir: "/opt/brc-analytics-{{ env.name }}/backend"
    brc_domain: "{{ env.domain }}"
    brc_environment: "{{ env.name }}"
    brc_repo_branch: "{{ env.branch }}"

- name: "Pull latest changes ({{ env.name }})"
  ansible.builtin.git:
    repo: "{{ brc_repo_url }}"
    dest: "{{ env_deploy_dir }}"
    version: "{{ env.branch }}"
    force: true
  become_user: "{{ brc_user }}"
  register: git_pull

# npm/catalog steps can be skipped for backend_only deployments because
# the catalog output files are committed to the repo and pulled with git
- name: "Check for catalog source changes ({{ env.name }})"
  ansible.builtin.command:
    cmd: git diff --name-only HEAD@{1} HEAD -- catalog/source/
    chdir: "{{ env_deploy_dir }}"
  become_user: "{{ brc_user }}"
  register: catalog_changes
  changed_when: false
  failed_when: false
  when: git_pull.changed and not (backend_only | default(false))

- name: "Rebuild catalog data ({{ env.name }})"
  ansible.builtin.command:
    cmd: npm run build-brc-db
    chdir: "{{ env_deploy_dir }}"
  become_user: "{{ brc_user }}"
  when: git_pull.changed and not (backend_only | default(false)) and catalog_changes.stdout | default('') | length > 0

- name: "Check for package-lock changes ({{ env.name }})"
  ansible.builtin.command:
    cmd: git diff --name-only HEAD@{1} HEAD -- package-lock.json
    chdir: "{{ env_deploy_dir }}"
  become_user: "{{ brc_user }}"
  register: npm_changes
  changed_when: false
  failed_when: false
  when: git_pull.changed and not (backend_only | default(false))

- name: "Update npm dependencies ({{ env.name }})"
  ansible.builtin.command:
    cmd: npm ci
    chdir: "{{ env_deploy_dir }}"
  become_user: "{{ brc_user }}"
  when: git_pull.changed and not (backend_only | default(false)) and npm_changes.stdout | default('') | length > 0

- name: "Template backend environment file ({{ env.name }})"
  ansible.builtin.template:
    src: templates/api.env.j2
    dest: "{{ env_backend_dir }}/api/.env"
    owner: "{{ brc_user }}"
    group: "{{ brc_group }}"
    mode: "0600"
  register: env_template

- name: "Template docker-compose override ({{ env.name }})"
  ansible.builtin.template:
    src: templates/docker-compose.backend-only.yml.j2
    dest: "{{ env_backend_dir }}/docker-compose.override.yml"
    owner: "{{ brc_user }}"
    group: "{{ brc_group }}"
    mode: "0644"
  register: compose_template

- name: "Rebuild and restart services ({{ env.name }})"
  ansible.builtin.command:
    cmd: docker compose -p brc-analytics-{{ env.name }} up -d --build --force-recreate
    chdir: "{{ env_backend_dir }}"
  become_user: "{{ brc_user }}"
  environment:
    APP_VERSION: "{{ lookup('file', env_deploy_dir + '/package.json') | from_json | json_query('version') }}"
  when: git_pull.changed or env_template.changed or compose_template.changed
  register: docker_restart

- name: "Wait for backend to be healthy ({{ env.name }})"
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ env.backend_port }}/api/v1/health"
    status_code: 200
  register: health_result
  until: health_result.status == 200
  retries: 30
  delay: 5
  when: docker_restart.changed | default(false)
